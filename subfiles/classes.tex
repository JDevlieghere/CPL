\documentclass[../main.tex]{subfiles}
\begin{document}

\subsection{Instanceof Operator}

\begin{lstlisting}
(define-datatype expression expression?
  ...
  (instanceof-exp
   (obj-exp expression?)
   (class-name symbol?)))


(define value-of
  (lambda (exp env)
    (cases expression exp
      ...
      (instanceof-exp (obj-exp class-name)
                       (let ((obj (value-of obj-exp env)))
                         (instanceof (object->class-name obj) class-name)))
      )))

;; Invalid instaceof
(define instanceof
  (lambda(obj-class-name class-name)
      (if (equal? obj-class-name class-name)
          #t
          (if (equal? obj-class-name 'object)
              #f
              (let ((class (lookup-class obj-class-name)))
                (instanceof (class->super-name class) class-name)
             )))))
\end{lstlisting}

\subsection{Field Getters \& Setters}

\begin{lstlisting}
;; Update datatype in syntax.rkt
(define-datatype expression expression?
  ...
 (fieldset-exp
   (obj-exp expression?)
   (field-name symbol?)
   (field-exp? expression?))
  (fieldref-exp
   (obj-exp expression?)
   (field-name symbol?)))

;; Add expressions to value-of
(define value-of
  (lambda (exp env)
    (cases expression exp
      ...
      (fieldset-exp (obj-exp field-name field-exp)
                    (let* ((obj (value-of obj-exp env))
                          (field-ref (lookup-field obj field-name))
                          (field-val (value-of field-exp env)))
                      (begin
                        (setref! field-ref field-val)
                        (num-val 0))))
      (fieldref-exp (obj-exp field-name)
                    (let ((obj (value-of obj-exp env)))
                      (value-of (deref (lookup-field field-name)))))

      )))

;; Helper function for obtaining reference to given field
;; lookup field name: Obj * Symbol -> Ref
(define lookup-field
  (lambda (obj field-name)
    (let* ((fields (object->fields obj))
           (class-name (object->class-name obj))
           (class (lookup-class class-name))
           (field-names (class->field-names class))
           (env (extend-env field-names fields (empty-env))))
           (apply-env env field-name))))
\end{lstlisting}

\end{document}